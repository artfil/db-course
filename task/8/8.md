# 8 - Репликация

### Цель:

- Сделать физическую и логическую репликации

***

### Физическая репликация:

1. Проверим, что наш мастер, не является репликой и создадим слот репликации с названием "replica_1"

![p1.png](p1.png)

2. Создадим контейнер, с названием otus_replica_1, который мы будем использовать в качестве ведомого

![p2.png](p2.png)

3. Пропишем адрес ведомого сервера в pg_hba.conf мастера

![p3.png](p3.png)

4. Перечитаем наш конфиг файл

![p4.png](p4.png)

5. Удалим директорию data у реплики и выполним команду pg_basebackup, после чего перезапустим контейнер

commands:
<pre>
rm -rf /var/lib/postgresql/data/

su - postgres
pg_basebackup -h 172.17.0.2 -R -D /var/lib/postgresql/data/ -U postgres --slot=replica_1
</pre>

6. После перезапуска проверим, что репликация выполнена, а наш текущий кластер стал репликой

![p5.png](p5.png)

7. Добавим отставание на 5 минут от мастера, и перезапустим контейнер

![p6.png](p6.png)

8. Создадим на мастере бд для тестирования отставания

![p7.png](p7.png)

9. Проверим, что на реплике её еще нет

![p8.png](p8.png)

10. Проверим спустя 5 минут (На последних 3 скринах время указано снизу справа)

![p9.png](p9.png)

11. В заключение посмотрим статусы на мастере и на реплике

![p10.png](p10.png)

![p11.png](p11.png)

### Логическая репликация:

1. Добавим в созданную таблицу replica_with_delay поля и данные

![p12.png](p12.png)

2. Добавим контейнер для логической репликации

![p13.png](p13.png)

3. Выполним команду на мастере и перезапустим контейнер

<pre>
ALTER SYSTEM SET wal_level = logical;
</pre>

![p14.png](p14.png)

4. Создадим публикацию и посмотрим что получилось

![p15.png](p15.png)

5. Создадим на второй реплике таблицу, подписку и проверим, что все получилось

![p16.png](p16.png)

6. Добавим данные на мастере и проверим, что они успешно реплицировались

![p17.png](p17.png)

![p18.png](p18.png)